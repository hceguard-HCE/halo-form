<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registro Halo CE</title>
<style>
  body { display: flex; justify-content: center; align-items: center; height: 100vh; font-family: Arial; background: #1b1b1b; color: #fff; }
  #container { background: #2c2c2c; padding: 30px; border-radius: 10px; width: 350px; text-align: center; }
  input, select, button { width: 100%; margin: 8px 0; padding: 8px; border-radius: 5px; border: none; }
  button { background: #4CAF50; color: white; cursor: pointer; }
  button:disabled { background: grey; }
  small { font-size: 12px; color: #ccc; display: block; margin-top: 10px; }
  .info p { margin: 5px 0; }
</style>
</head>
<body>
<div id="container">
  <h2>Registro Halo CE</h2>
  
  <form id="registroForm">
    <input type="text" id="nick" placeholder="Nick en Halo CE" required>
    <input type="text" id="pais" placeholder="País" required>
    <input type="text" id="servidores" placeholder="¿En qué servidores juegas?" required>
    <select id="prefJuego" required>
      <option value="">¿Cómo prefieres jugar Halo CE?</option>
      <option value="Pro / competitivo">Pro / competitivo</option>
      <option value="Casual / recreativo">Casual / recreativo</option>
    </select>
    <textarea id="motivo" placeholder="Motivo para unirse" required></textarea>
    <button type="submit">Crear</button>
    <small>12–48 horas para revisión, salvo recomendación de un administrador.</small>
  </form>

  <div id="estadoDiv" style="display:none;">
    <h3>Tu Información</h3>
    <div class="info" id="infoUsuario"></div>
    <p>Estado: <span id="estadoUsuario">Activo</span></p>
    <button id="btnConectar">Conectar</button>
    <button id="btnDesconectar">Desconectar</button>
    <p id="mensaje"></p>
  </div>
</div>

<script>
const form = document.getElementById("registroForm");
const estadoDiv = document.getElementById("estadoDiv");
const infoUsuario = document.getElementById("infoUsuario");
const btnConectar = document.getElementById("btnConectar");
const btnDesconectar = document.getElementById("btnDesconectar");
const mensaje = document.getElementById("mensaje");

function getDeviceID() {
  if(!localStorage.getItem("deviceID")) {
    const id = crypto.randomUUID();
    localStorage.setItem("deviceID", id);
  }
  return localStorage.getItem("deviceID");
}
const deviceID = getDeviceID();

form.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const data = {
    nick: document.getElementById("nick").value,
    pais: document.getElementById("pais").value,
    servidores: document.getElementById("servidores").value,
    prefJuego: document.getElementById("prefJuego").value,
    motivo: document.getElementById("motivo").value,
    deviceID
  };

  try {
    // Revisar si está aprobado
    const check = await fetch(`/check/${deviceID}`);
    const status = await check.json();
    if(!status.aprobado){
      mensaje.textContent = "⏳ Tu registro está pendiente de aprobación en Discord.";
      return;
    }

    localStorage.setItem("usuarioData", JSON.stringify(data));
    form.style.display = "none";
    estadoDiv.style.display = "block";
    infoUsuario.innerHTML = `
      <p>Nick: ${data.nick}</p>
      <p>País: ${data.pais}</p>
      <p>Servidores: ${data.servidores}</p>
      <p>Preferencia: ${data.prefJuego}</p>
      <p>Motivo: ${data.motivo}</p>
    `;
  } catch(err){
    console.error(err);
    mensaje.textContent = "Error de conexión con el servidor.";
  }
});

btnConectar.addEventListener("click", async ()=>{
  const data = JSON.parse(localStorage.getItem("usuarioData"));
  try {
    const res = await fetch("/conectar", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ userId: deviceID, nick: data.nick, prefJuego: data.prefJuego })
    });
    const json = await res.json();
    if(json.ok){
      mensaje.textContent = "✅ Ya puedes ingresar a cualquier servidor de Halo CE.";
      btnConectar.style.display = "none";
    }
  } catch(err){
    console.error(err);
    mensaje.textContent = "Error al conectarse.";
  }
});

btnDesconectar.addEventListener("click", async ()=>{
  const data = JSON.parse(localStorage.getItem("usuarioData"));
  try {
    await fetch("/desconectar", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ nick: data.nick })
    });
    mensaje.textContent = "⚠️ Te has desconectado.";
    btnDesconectar.style.display = "none";
  } catch(err){
    console.error(err);
    mensaje.textContent = "Error al desconectarse.";
  }
});

// Mostrar estado si ya estaba registrado
if(localStorage.getItem("usuarioData")){
  const data = JSON.parse(localStorage.getItem("usuarioData"));
  form.style.display = "none";
  estadoDiv.style.display = "block";
  infoUsuario.innerHTML = `
    <p>Nick: ${data.nick}</p>
    <p>País: ${data.pais}</p>
    <p>Servidores: ${data.servidores}</p>
    <p>Preferencia: ${data.prefJuego}</p>
    <p>Motivo: ${data.motivo}</p>
  `;
}
</script>
</body>
</html>
