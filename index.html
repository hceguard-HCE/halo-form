<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registro Halo CE</title>
<style>
  body { display:flex; justify-content:center; align-items:center; height:100vh; font-family:Arial; background:#1b1b1b; color:#fff; }
  #container { background:#2c2c2c; padding:30px; border-radius:10px; width:350px; text-align:center; }
  input, select, textarea, button { width:100%; margin:8px 0; padding:8px; border-radius:5px; border:none; }
  textarea { resize:none; height:60px; }
  button { background:#4CAF50; color:white; cursor:pointer; }
  button:disabled { background:grey; }
  small { font-size:12px; color:#ccc; display:block; margin-top:10px; }
  #estadoDiv p { text-align:left; white-space:pre-line; }
</style>
</head>
<body>
<div id="container">
  <h2>Registro Halo CE</h2>
  <form id="registroForm">
    <input type="text" id="nick" placeholder="Nick en Halo CE" required pattern="^[a-zA-Z0-9_]+$" title="Solo letras, números y guion bajo">
    <input type="text" id="pais" placeholder="País" required>
    <input type="text" id="servidores" placeholder="¿En qué servidores juegas?" required>
    <select id="prefJuego" required>
      <option value="">¿Cómo prefieres jugar Halo CE?</option>
      <option value="Pro / competitivo">Pro / competitivo</option>
      <option value="Casual / recreativo">Casual / recreativo</option>
    </select>
    <textarea id="motivo" placeholder="Motivo para unirse" required></textarea>
    <button type="submit">Crear</button>
    <small>12–48 horas para revisar, salvo recomendación de un administrador.</small>
  </form>

  <div id="estadoDiv" style="display:none;">
    <h3>Tu Información</h3>
    <p id="infoUsuario"></p>
    <p>Estado: <span id="estadoUsuario">Pendiente</span></p>
    <button id="btnConectar">Conectar</button>
    <button id="btnDesconectar">Desconectar</button>
    <p id="msjConexion" style="margin-top:10px;color:#4CAF50;"></p>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("registroForm");
  const estadoDiv = document.getElementById("estadoDiv");
  const infoUsuario = document.getElementById("infoUsuario");
  const estadoUsuario = document.getElementById("estadoUsuario");
  const btnConectar = document.getElementById("btnConectar");
  const btnDesconectar = document.getElementById("btnDesconectar");
  const msjConexion = document.getElementById("msjConexion");

  function getDeviceID() {
    if(!localStorage.getItem("deviceID")) {
      const id = crypto.randomUUID();
      localStorage.setItem("deviceID", id);
    }
    return localStorage.getItem("deviceID");
  }
  const deviceID = getDeviceID();

  function mostrarUsuario(data){
    infoUsuario.textContent = 
      `Nick: ${data.nick}\nPaís: ${data.pais}\nServidores: ${data.servidores}\nPreferencia: ${data.prefJuego}\nMotivo: ${data.motivo}`;
  }

  // Si ya hay registro en localStorage
  if(localStorage.getItem("usuarioData")){
    const data = JSON.parse(localStorage.getItem("usuarioData"));
    form.style.display = "none";
    estadoDiv.style.display = "block";
    mostrarUsuario(data);

    // Revisar si aprobado
    fetch(`/check/${deviceID}`)
      .then(r => r.json())
      .then(json => { estadoUsuario.textContent = json.aprobado ? "Aprobado" : "Pendiente"; });
  }

  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const data = {
      nick: document.getElementById("nick").value,
      pais: document.getElementById("pais").value,
      servidores: document.getElementById("servidores").value,
      prefJuego: document.getElementById("prefJuego").value,
      motivo: document.getElementById("motivo").value,
      deviceID
    };

    try {
      const res = await fetch("/registro", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(data)
      });
      const json = await res.json();
      if(json.ok){
        localStorage.setItem("usuarioData", JSON.stringify(data));
        form.style.display = "none";
        estadoDiv.style.display = "block";
        mostrarUsuario(data);
        estadoUsuario.textContent = "Pendiente";
      } else {
        console.error("Error en registro backend");
      }
    } catch(err){
      console.error("Error de conexión:", err);
    }
  });

  btnConectar.addEventListener("click", async ()=>{
    const data = JSON.parse(localStorage.getItem("usuarioData"));
    try{
      const res = await fetch("/conectar", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({nick: data.nick, prefJuego: data.prefJuego})
      });
      const json = await res.json();
      if(json.ok){
        msjConexion.textContent = "✅ Ahora puedes ingresar a cualquier servidor de Halo CE";
        btnConectar.disabled = true;
        btnDesconectar.disabled = false;
      }
    } catch(err){
      console.error(err);
    }
  });

  btnDesconectar.addEventListener("click", async ()=>{
    const data = JSON.parse(localStorage.getItem("usuarioData"));
    try{
      const res = await fetch("/desconectar", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({nick: data.nick})
      });
      const json = await res.json();
      if(json.ok){
        msjConexion.textContent = "❌ Te has desconectado.";
        btnConectar.disabled = false;
        btnDesconectar.disabled = true;
      }
    } catch(err){
      console.error(err);
    }
  });

  // Inicializar botones
  btnConectar.disabled = false;
  btnDesconectar.disabled = true;
});
</script>
</body>
</html>
