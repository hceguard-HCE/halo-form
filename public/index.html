<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registro Halo CE</title>
<style>
  body { display:flex; justify-content:center; align-items:center; height:100vh; font-family:Arial; background:#1b1b1b; color:#fff; }
  #container { background:#2c2c2c; padding:30px; border-radius:10px; width:350px; text-align:center; }
  input, select, textarea, button { width:100%; margin:8px 0; padding:8px; border-radius:5px; border:none; }
  textarea { resize:none; height:60px; }
  button { background:#4CAF50; color:white; cursor:pointer; }
  button:disabled { background:grey; }
  small { font-size:12px; color:#ccc; display:block; margin-top:10px; }
</style>
</head>
<body>
<div id="container">
  <h2>Registro Halo CE</h2>
  
  <form id="registroForm">
    <input type="text" id="nick" placeholder="Nick en Halo CE" required pattern="^[a-zA-Z0-9_]+$" title="Solo letras, números y guion bajo">
    <input type="text" id="pais" placeholder="País" required>
    <input type="text" id="servidores" placeholder="¿En qué servidores juegas?" required>
    <select id="prefJuego" required>
      <option value="">¿Cómo prefieres jugar Halo CE?</option>
      <option value="Pro / competitivo">Pro / competitivo</option>
      <option value="Casual / recreativo">Casual / recreativo</option>
    </select>
    <textarea id="motivo" placeholder="Motivo para unirse" required></textarea>
    <button type="submit">Crear</button>
    <small>12–48 horas para revisar, salvo recomendación de un administrador.</small>
  </form>

  <div id="estadoDiv" style="display:none;">
    <h3>Tu Información</h3>
    <pre id="infoUsuario"></pre>
    <p>Estado: <span id="estadoUsuario">Pendiente</span></p>
    <button id="btnConectar" style="display:none">Conectar</button>
  </div>
</div>

<script>
const form = document.getElementById("registroForm");
const estadoDiv = document.getElementById("estadoDiv");
const infoUsuario = document.getElementById("infoUsuario");
const btnConectar = document.getElementById("btnConectar");

// Device ID persistente
function getDeviceID() {
  if(!localStorage.getItem("deviceID")) {
    const id = crypto.randomUUID();
    localStorage.setItem("deviceID", id);
  }
  return localStorage.getItem("deviceID");
}

const deviceID = getDeviceID();

// Mostrar estado si ya existe usuario registrado
if(localStorage.getItem("usuarioData")) {
  form.style.display = "none";
  estadoDiv.style.display = "block";
  const data = JSON.parse(localStorage.getItem("usuarioData"));
  infoUsuario.textContent = `Nick: ${data.nick}\nPaís: ${data.pais}\nServidores: ${data.servidores}\nPreferencia: ${data.prefJuego}\nMotivo: ${data.motivo}`;
}

// Enviar formulario al backend
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const data = {
    nick: document.getElementById("nick").value,
    pais: document.getElementById("pais").value,
    servidores: document.getElementById("servidores").value,
    prefJuego: document.getElementById("prefJuego").value,
    motivo: document.getElementById("motivo").value,
    deviceID
  };

  try {
    const res = await fetch("/registro", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    const json = await res.json();
    if(json.ok){
      localStorage.setItem("usuarioData", JSON.stringify(data));
      form.style.display = "none";
      estadoDiv.style.display = "block";
      infoUsuario.textContent = `Nick: ${data.nick}\nPaís: ${data.pais}\nServidores: ${data.servidores}\nPreferencia: ${data.prefJuego}\nMotivo: ${data.motivo}`;
      document.getElementById("estadoUsuario").textContent = "Pendiente";
      btnConectar.style.display = "none";
    } else {
      alert("Error al enviar el registro");
    }
  } catch(err) {
    console.error(err);
    alert("Error de conexión con el servidor");
  }
});

// Botón Conectar
btnConectar.addEventListener("click", () => {
  alert("Conectando a Halo CE con tu cuenta...");
});

// Revisar estado cada 10s
async function checkEstado() {
  const data = JSON.parse(localStorage.getItem("usuarioData"));
  if(!data) return;

  try {
    const res = await fetch(`/check/${data.deviceID}`);
    const json = await res.json();

    if(json.aprobado){
      document.getElementById("estadoUsuario").textContent = "Activo";
      infoUsuario.style.display = "block";
      btnConectar.style.display = "block";
      btnConectar.disabled = false;
    } else {
      document.getElementById("estadoUsuario").textContent = "Pendiente";
      btnConectar.style.display = "none";
      btnConectar.disabled = true;
    }
  } catch(err){
    console.error(err);
  }
}

setInterval(checkEstado, 10000);
checkEstado();
</script>
</body>
</html>
