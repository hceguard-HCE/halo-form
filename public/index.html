<div id="estadoDiv" style="display:none;">
  <h3>Tu Información</h3>
  <pre id="infoUsuario"></pre>
  <p>Estado: <span id="estadoUsuario">Pendiente</span></p>
  <button id="btnConectar" style="display:none">Conectar</button>
  <button id="btnDesconectar" style="display:none">Desconectar</button>
  <p id="mensajeServidor" style="color:#0f0; margin-top:10px; display:none;">✅ Ya puedes ingresar a cualquier servidor de Halo CE</p>
</div>

<script>
const form = document.getElementById("registroForm");
const estadoDiv = document.getElementById("estadoDiv");
const infoUsuario = document.getElementById("infoUsuario");
const btnConectar = document.getElementById("btnConectar");
const btnDesconectar = document.getElementById("btnDesconectar");
const mensajeServidor = document.getElementById("mensajeServidor");

function getDeviceID() {
  if(!localStorage.getItem("deviceID")) {
    const id = crypto.randomUUID();
    localStorage.setItem("deviceID", id);
  }
  return localStorage.getItem("deviceID");
}
const deviceID = getDeviceID();

function mostrarDatosUsuario(data){
  infoUsuario.textContent = 
    `Nick: ${data.nick}\nPaís: ${data.pais}\nServidores: ${data.servidores}\nPreferencia: ${data.prefJuego}\nMotivo: ${data.motivo}`;
}

form.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const data = {
    nick: document.getElementById("nick").value,
    pais: document.getElementById("pais").value,
    servidores: document.getElementById("servidores").value,
    prefJuego: document.getElementById("prefJuego").value,
    motivo: document.getElementById("motivo").value,
    deviceID
  };

  try {
    const res = await fetch("/registro", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(data)
    });
    const json = await res.json();
    if(json.ok){
      localStorage.setItem("usuarioData", JSON.stringify(data));
      form.style.display = "none";
      estadoDiv.style.display = "block";
      mostrarDatosUsuario(data);
    }
  } catch(err){
    console.error(err);
  }
});

// Revisar aprobación cada 10s
async function checkEstado(){
  const data = JSON.parse(localStorage.getItem("usuarioData"));
  if(!data) return;

  try {
    const res = await fetch(`/check/${deviceID}`);
    const json = await res.json();
    if(json.aprobado){
      document.getElementById("estadoUsuario").textContent = "Activo";
      btnConectar.style.display = "inline-block";
      mensajeServidor.style.display = "block";
    } else {
      document.getElementById("estadoUsuario").textContent = "Pendiente";
      btnConectar.style.display = "none";
      mensajeServidor.style.display = "none";
    }
  } catch(err){
    console.error(err);
  }
}

setInterval(checkEstado, 10000);
checkEstado();

// Conectar
btnConectar.addEventListener("click", async ()=>{
  const data = JSON.parse(localStorage.getItem("usuarioData"));
  try {
    await fetch("/conectar", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ nick: data.nick, prefJuego: data.prefJuego })
    });
    btnConectar.style.display = "none";
    btnDesconectar.style.display = "inline-block";
  } catch(err){ console.error(err); }
});

// Desconectar
btnDesconectar.addEventListener("click", async ()=>{
  const data = JSON.parse(localStorage.getItem("usuarioData"));
  try {
    await fetch("/desconectar", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ nick: data.nick })
    });
    btnDesconectar.style.display = "none";
    btnConectar.style.display = "inline-block";
  } catch(err){ console.error(err); }
});
</script>
